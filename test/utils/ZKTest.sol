// SPDX-License-Identifier: MIT
pragma solidity 0.8.30;

import "forge-std/Test.sol";
import {IRegistrationVerifier} from "../../src/RegistrationVerifier.sol";

abstract contract ZKTest is Test {
    string constant TITLE = unicode"隱私池的設計 by cc liang";
    address constant RECIPIENT = 0xd78B5013757Ea4A7841811eF770711e6248dC282;
    address constant NEW_RECIPIENT = 0x9e8f8C3Ad87dBE7ACFFC5f5800e7433c8dF409F2;
    bytes32 constant REGISTRATION_HEADER_HASH = 0x86cbd6a1dcf53636ccfe282575446622847dba5be5bd08cc1d00b5e5f53243d5;
    bytes32 constant RECIPIENT_UPDATE_HEADER_HASH = 0xc6f6f9f6da412891ba108edbfd76778d6aa7f502697580a5d0497f5bf49e7a2f;
    bytes32 constant USER_OP_HASH = keccak256(bytes(unicode"dummy-registration"));

    function parseJsonProof(string memory fileName)
        internal
        view
        returns (IRegistrationVerifier.ZkEmailProof memory proof)
    {
        string memory root = vm.projectRoot();
        string memory path = string.concat(root, "/", fileName, ".json");
        string memory json = vm.readFile(path);

        // Parse each array element
        uint256[] memory aArray = vm.parseJsonUintArray(json, ".[0]");
        proof.a = [aArray[0], aArray[1]];

        // For nested b array, parse each sub-array
        uint256[] memory b0Array = vm.parseJsonUintArray(json, ".[1][0]");
        uint256[] memory b1Array = vm.parseJsonUintArray(json, ".[1][1]");
        proof.b = [[b0Array[0], b0Array[1]], [b1Array[0], b1Array[1]]];

        uint256[] memory cArray = vm.parseJsonUintArray(json, ".[2]");
        proof.c = [cArray[0], cArray[1]];

        uint256[] memory signalsArray = vm.parseJsonUintArray(json, ".[3]");
        for (uint256 i = 0; i < signalsArray.length; i++) {
            proof.signals[i] = signalsArray[i];
        }
    }

    function validRegistrationProof() public pure returns (IRegistrationVerifier.ZkEmailProof memory proof) {
        proof.a = [
            15079434728038681406501988292748094869787636503650786645635696617389527160198,
            6539495755486731060503602139436336513883918629297276397940144733221575241667
        ];

        proof.b = [
            [
                18401829150259348256228845317351717223437482311982435259794478755504007373447,
                8725332773268433843165574421036866161612808562729673062539458029466363387084
            ],
            [
                9091563866849905882041262217201834402761912958607458749787334686795245034839,
                14756969788347689318916486666960228906353639712772840276331998501047197745816
            ]
        ];

        proof.c = [
            6298964400474009330826920054498273558853663948786118976231232703125189073420,
            10468932411024853152106768186312070225955300758821149141662194811698825554691
        ];

        proof.signals = [
            6632353713085157925504008443078919716322386156160602218536961028046468237192,
            179174940957233788236917956282329359906,
            176110912359975412458775129071667004373,
            144410967236643786077007722,
            4992959312512230116538335825132076927052637790830533900315071821365,
            0,
            177045085285232709542537618269527952589681117750617699131261990920761210928,
            92257159006731089366315165519870804725597858279156282923563106939566373177,
            1664575074,
            86956402115569186678976683596652684038744075192332976861274474050868246576,
            60711670697043939388974385,
            0,
            175623169235831462012555507320332121853822492850461715729383597280344635440,
            86949585669759892137776293893024742922374716279324892407328097120528196153,
            895639908
        ];
    }

    function invalidRegistrationProof() public pure returns (IRegistrationVerifier.ZkEmailProof memory proof) {
        proof.a = [
            18934028016795292889386004767959221280264576135060467850406680745356007626208,
            21742944423135095759008147910721374038406480292108090086971597591197236024431
        ];
        proof.b = [
            [
                8702770492825940100486851008893891744533823382441559718215625425048196439276,
                20899738712473660960150119335816994870243940847381516082179541847894644933991
            ],
            [
                9310875041182391953836127804078358707544441709820071957081868254044758354315,
                12854456186867777722016432207378163693126246482709937305937330585084676514219
            ]
        ];
        proof.c = [
            21696105522320434270673407119057739173593811473253400129108828332862349551519,
            21176221058607470105830444214285676365984616261744192380547922540242855420632
        ];
        proof.signals = validRegistrationProof().signals;
    }

    function validRecipientUpdateProof() public pure returns (IRegistrationVerifier.ZkEmailProof memory proof) {
        proof.a = [
            4018136461791027286914618436606290414344696636478290738794844706430822560426,
            13252273705155454510658968053686903771637836686403711688426135294060146078619
        ];
        proof.b = [
            [
                6334117094010874942498045470543616516217083462356225668698109389601800348314,
                19915045859788681389451684686831030703260167384129862985545455081837113100579
            ],
            [
                5453822190244345176541922033409946666164234153861606817919269667800750398448,
                6665133758330033167014630551345861317337222771948150823604393857387393721661
            ]
        ];
        proof.c = [
            7260544986517160480707919068299776994264038070006073104109247472357372152145,
            13034476357493974927186543314337227319852610005507159117945624077689650096609
        ];
        proof.signals = [
            6632353713085157925504008443078919716322386156160602218536961028046468237192,
            264469518070278702108707665428113422221,
            141770250510023596303318074112666925615,
            144410967236643786077007722,
            185893070597506392968176665448466928770679305951148005942719960109701346869,
            95285067689723810438499876746722580514607937107503,
            177045085285232709542537618269527952589681117750617699131261990920761210928,
            92257159006731089366315165519870804725597858279156282923563106939566373177,
            1664575074,
            92258371446989226862863840489592751872830699590570610695842248449305704496,
            60777911572423144210903859,
            0,
            175623169235831462012555507320332121853822492850461715729383597280344635440,
            86949585669759892137776293893024742922374716279324892407328097120528196153,
            895639908
        ];
    }

    function invalidRecipientUpdateProof() public pure returns (IRegistrationVerifier.ZkEmailProof memory proof) {
        proof.a = [
            2450860719228967192997805668345039759229368610646875235730187188882570986758,
            11956226373774441102945475744890380251197331646836627720038906069479132207381
        ];
        proof.b = [
            [
                18248877780913921530083547615899683364661990498678907921970074466459363917700,
                3028804882044498359539369696273030642474359928408694834832122009946949733744
            ],
            [
                9001189658807938079279279031705971353795476850873325722471037507520117041508,
                6966781060536991917637335620911617811245545063429740259139359720093424196565
            ]
        ];
        proof.c = [
            18593115340800706504356910555404382584903769897905582735122167735533100537196,
            9805425593160771369794343616016691498583969073420592552522464055452791352446
        ];
        proof.signals = validRecipientUpdateProof().signals;
    }
}
